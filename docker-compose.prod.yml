version: '3.8'

services:
  backend:
    build: ./backend
    restart: always
    expose:
      - "3000"
    environment:
      - PORT=3000
      - DATABASE_PATH=/app/data/zapcar.db
      - JWT_SECRET=${JWT_SECRET:-super-secret-key-change-this}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ASAAS_API_KEY=${ASAAS_API_KEY}
      - ASAAS_API_URL=${ASAAS_API_URL}
      - EVOLUTION_API_URL=http://evolution-api:8080
      - EVOLUTION_API_KEY=429683C4C977415CAAFCCE10F7D57E11
      - WEBHOOK_URL=http://backend:3000/whatsapp/webhook
    depends_on:
      - evolution-api
    volumes:
      - zapcar_data:/app/data
      - zapcar_uploads:/app/uploads

  frontend:
    build: ./frontend
    restart: always
    expose:
      - "80"
    depends_on:
      - backend

  evolution-api:
    image: atendai/evolution-api:v2.2.0
    restart: always
    expose:
      - "8080"
    environment:
      - SERVER_PORT=8080
      - SERVER_URL=http://evolution-api:8080
      - AUTHENTICATION_API_KEY=429683C4C977415CAAFCCE10F7D57E11
      - AUTHENTICATION_EXPOSE_IN_NAVIGATION=true
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution:evolution@postgres:5432/evolution
      - DATABASE_CLIENT_NAME=evolution_exchange
      - REDIS_ENABLED=true
      - REDIS_URI=redis://redis:6379/1
      - REDIS_PREFIX_KEY=evolution
    depends_on:
      - postgres
      - redis
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store

  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      - POSTGRES_USER=evolution
      - POSTGRES_PASSWORD=evolution
      - POSTGRES_DB=evolution
    volumes:
      - evolution_postgres:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - evolution_redis:/data

volumes:
  zapcar_data:
  zapcar_uploads:
  evolution_instances:
  evolution_store:
  evolution_postgres:
  evolution_redis:
